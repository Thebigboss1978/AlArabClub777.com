<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¨ÙˆØ§Ø¨Ø© ÙˆÙƒØ§Ù„Ø© AlArab AI â€” Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¢ÙŠØ¨Ø§Ø¯</title>
  <style>
    :root{
      --bg:#0b0f14;
      --glass:#ffffff22;
      --accent:#7ee787;
      --muted:#cbd5e1;
      --glass-strong:#ffffff33;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: dark;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071021 0%, #06131a 100%);color:var(--muted)}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:100%;max-width:980px;background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter: blur(10px) saturate(120%);border-radius:16px;padding:18px;border:1px solid var(--glass);box-shadow:0 10px 30px rgba(0,0,0,0.5)}
    .header{display:flex;flex-wrap: wrap; justify-content:space-between;align-items:center;padding-bottom:15px;border-bottom:1px solid var(--glass-strong)}
    .header h1{font-size:1.5rem;color:var(--accent);margin:0}
    .chat-container{height:60vh;overflow-y:auto;padding-right:15px;margin-bottom:15px;display:flex;flex-direction:column}
    .msg-wrap{display:flex;margin-bottom:15px;align-items:flex-start}
    .icon{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.8rem;margin-left:10px;flex-shrink:0}
    .user-icon{background:#007bff;color:#fff}
    .assistant-icon{background:var(--accent);color:#0b0f14}
    .msg{background:var(--glass);padding:10px 15px;border-radius:12px;max-width:80%;font-size:0.9rem;line-height:1.4}
    .user-msg .msg{margin-left:auto;background:var(--glass-strong)}
    .input-area{display:flex;gap:10px;margin-top:15px}
    .input-area textarea{flex-grow:1;background:var(--glass);border:1px solid var(--glass-strong);border-radius:12px;padding:10px;color:var(--muted);resize:none}
    .input-area button{background:var(--accent);color:#0b0f14;border:none;border-radius:12px;padding:10px 20px;cursor:pointer;font-weight:600;transition:background 0.2s}
    .input-area button:hover{background:#5cb85c}
    .log{font-size:0.75rem;color:#ffc107;margin-top:10px;padding:5px;border-top:1px solid var(--glass);max-height:100px;overflow-y:auto}
    .controls{display:flex;gap:10px;flex-wrap: wrap; align-items: center;}
    .controls select, .controls button, .controls input{background:var(--glass);border:1px solid var(--glass-strong);border-radius:12px;padding:8px 15px;color:var(--muted);cursor:pointer;font-size:0.8rem}
    .controls button:hover{background:var(--glass-strong)}
    .ip-input{flex-grow: 1; max-width: 150px;}
    @media (max-width: 600px) {
        .card{padding:10px;margin:10px}
        .chat-container{height:50vh}
        .input-area{flex-direction:column}
        .input-area button{width:100%}
        .controls{flex-direction:column}
        .ip-input{max-width: 100%;}
    }
    .disabled-button { opacity: 0.5; pointer-events: none; }
    .client-id { background-color: var(--glass-strong); padding: 5px 10px; border-radius: 8px; font-size: 0.8rem; margin-left: 10px; color: var(--accent); }
    .status-badge { background-color: #f00; color: white; padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; margin-right: 5px; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }

    /* ====== Execution Flow Design ====== */
    .execution-flow {
      margin-top: 25px;
      border-top: 1px solid var(--glass);
      padding-top: 15px;
    }
    .execution-flow h2 {
      font-size: 1.2rem;
      color: var(--accent);
      margin-bottom: 15px;
      text-align: center;
    }
    .flow-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      position: relative;
    }
    .flow-step {
      display: flex;
      align-items: flex-start;
      background: var(--glass);
      border-radius: 12px;
      padding: 10px 15px;
      width: 100%;
      max-width: 700px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.25);
      transition: transform 0.3s, background 0.3s;
    }
    .flow-step:hover {
      background: var(--glass-strong);
      transform: scale(1.02);
    }
    .flow-step .circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--accent);
      color: #0b0f14;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 15px;
      flex-shrink: 0;
    }
    .flow-step .text { flex-grow: 1; }
    .flow-step strong { color: #fff; display: block; font-size: 0.95rem; margin-bottom: 3px; }
    .flow-step p { margin: 0; font-size: 0.8rem; color: var(--muted); line-height: 1.4; }
    .arrow { font-size: 1.4rem; color: var(--accent); animation: bounce 1.5s infinite; }
    @keyframes bounce { 0%,100% { transform: translateY(0); } 50% { transform: translateY(4px); } }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="header">
      <h1>Ø¨ÙˆØ§Ø¨Ø© ÙˆÙƒØ§Ù„Ø© AlArab AI</h1>
      <div class="controls">
        <span id="connection-status" class="status-badge">ØºÙŠØ± Ù…ØªØµÙ„</span>
        <input type="text" id="api-ip" class="ip-input" value="127.0.0.1" placeholder="IP: 192.168.x.x" onchange="updateGatewayURL(this.value)">
        <select id="model-select"></select>
        <span class="client-id" id="client-display">Client: ...</span>
      </div>
    </div>

    <div class="chat-container" id="chat-container"></div>

    <div class="input-area">
      <textarea id="user-input" placeholder="Ø§ÙƒØªØ¨ Ø·Ù„Ø¨Ùƒ Ù„ÙˆÙƒÙŠÙ„ 'Ø§Ù„Ù…Ø¹Ø²Ø² Ø§Ù„Ø¯Ø§Ø¹Ù…' Ù‡Ù†Ø§..."></textarea>
      <button id="send-button" onclick="sendMessage(document.getElementById('user-input').value)">Ø¥Ø±Ø³Ø§Ù„ (ØªÙ†ÙÙŠØ°)</button>
    </div>

    <div class="log" id="log-container">
      ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ÙˆØ§Ù† IP Ù„Ù€ Mac/PC ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰. Ø«Ù… Ø­Ù…Ù„ Ø§Ù„ØµÙØ­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¢ÙŠØ¨Ø§Ø¯ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø°Ù„Ùƒ Ø§Ù„Ù€ IP ÙˆØ§Ù„Ù…Ù†ÙØ° 8000.
    </div>

    <!-- ====== Execution Flow ====== -->
    <div class="execution-flow">
      <h2>âš™ï¸ Execution Flow (Ø·Ù„Ø¨ â†’ Ù†Ù…ÙˆØ°Ø¬ â†’ Ù†ØªÙŠØ¬Ø©)</h2>
      <div class="flow-container">
        <div class="flow-step"><div class="circle">1</div><div class="text"><strong>User Request Layer</strong><p>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙØ¯Ø®Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.</p></div></div>
        <div class="arrow">â†“</div>
        <div class="flow-step"><div class="circle">2</div><div class="text"><strong>Orchestration Layer</strong><p>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø£Ù†Ø³Ø¨.</p></div></div>
        <div class="arrow">â†“</div>
        <div class="flow-step"><div class="circle">3</div><div class="text"><strong>Model Execution Layer</strong><p>ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©.</p></div></div>
        <div class="arrow">â†“</div>
        <div class="flow-step"><div class="circle">4</div><div class="text"><strong>Output Delivery Layer</strong><p>ØªØ³Ù„ÙŠÙ… Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù….</p></div></div>
      </div>
    </div>

  </div>
</div>

<script>
let CONFIG = {
  API_GATEWAY_URL: 'http://127.0.0.1:8000',
  OLLAMA_BASE: 'http://127.0.0.1:11434',
  DEFAULT_CLIENT_ID: 'AlArab_Agency_Pilot_Client_1'
};
const EXTERNAL_MODELS = [
  { name: 'Gemini 2.5 Flash (Cloud)', value: 'gemini-2.5-flash' },
  { name: 'Gemini 2.5 Pro (Cloud)', value: 'gemini-2.5-pro' }
];

function appendLog(message){
  const c=document.getElementById('log-container');
  const p=document.createElement('p');
  p.textContent=`[${new Date().toLocaleTimeString()}] ${message}`;
  c.appendChild(p);c.scrollTop=c.scrollHeight;
}
function appendMessage(text,role){
  const chat=document.getElementById('chat-container');
  const w=document.createElement('div');w.classList.add('msg-wrap',`${role}-msg`);
  const i=document.createElement('div');i.classList.add('icon',`${role}-icon`);i.textContent=role==='user'?'Ø£Ù†Øª':'ÙˆÙƒÙŠÙ„';
  const m=document.createElement('div');m.classList.add('msg');m.innerHTML=text.replace(/\n/g,'<br>');
  if(role==='user'){w.appendChild(m);w.appendChild(i);}else{w.appendChild(i);w.appendChild(m);}
  chat.appendChild(w);chat.scrollTop=chat.scrollHeight;
}
function setConnectionStatus(ok){
  const s=document.getElementById('connection-status');
  if(ok){s.textContent='Ù…ØªØµÙ„';s.style.backgroundColor='#1e7e34';s.style.animation='none';}
  else{s.textContent='ØºÙŠØ± Ù…ØªØµÙ„';s.style.backgroundColor='#f00';s.style.animation='pulse 1.5s infinite';}
}
function updateGatewayURL(ip){
  CONFIG.API_GATEWAY_URL=`http://${ip}:8000`;
  CONFIG.OLLAMA_BASE=`http://${ip}:11434`;
  appendLog(`ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ Gateway Ø¥Ù„Ù‰: ${CONFIG.API_GATEWAY_URL}`);
  fetchModels();
}
async function sendMessage(text){
  if(text.trim()==='')return;
  const btn=document.getElementById('send-button');
  const area=document.getElementById('user-input');
  const modelSel=document.getElementById('model-select');
  const model=modelSel.value;
  if(!model){appendLog('ERROR: Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙˆÙƒÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.');return;}
  highlightFlowStep(0);
  appendLog('ğŸ§  [Step 1] Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨...');
  btn.classList.add('disabled-button');btn.textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...';area.value='';
  appendMessage(text,'user');
  const payload={model_name:model,prompt:text,client_id:CONFIG.DEFAULT_CLIENT_ID,history:[]};
  let assistantMessage='';
  try{
    highlightFlowStep(1);
    appendLog('âš™ï¸ [Step 2] Ø¨Ø¯Ø¡ Orchestration...');
    const r=await fetch(`${CONFIG.API_GATEWAY_URL}/api/agent/query`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok){const e=await r.json().catch(()=>({detail:r.statusText}));throw new Error(`Ø®Ø·Ø£ (${r.status}): ${e.detail}`);}
    highlightFlowStep(2);
    appendLog('ğŸ¤– [Step 3] ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...');
    const data=await r.json();
    assistantMessage=data.response;
    appendLog(`ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø°Ø§ÙƒØ±Ø©: ${data.context_retrieved?.substring(0,50)??''}...`);
    setConnectionStatus(true);
  }catch(e){
    assistantMessage=`âŒ Ø®Ø·Ø£: ${e.message}`;
    appendLog(assistantMessage);setConnectionStatus(false);
  }
  highlightFlowStep(3);
  appendLog('ğŸ“¤ [Step 4] Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø©...');
  appendMessage(assistantMessage,'assistant');
  if(assistantMessage&&!assistantMessage.includes('Its_not_doable.'))await saveMemory(text,assistantMessage);
  btn.classList.remove('disabled-button');btn.textContent='Ø¥Ø±Ø³Ø§Ù„ (ØªÙ†ÙÙŠØ°)';
  setTimeout(()=>highlightFlowStep(0),3000);
}
async function saveMemory(u,a){
  const c=`USER: ${u} | ASSISTANT: ${a}`;
  try{
    const r=await fetch(`${CONFIG.API_GATEWAY_URL}/api/memory/save`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({client_id:CONFIG.DEFAULT_CLIENT_ID,text_chunk:c})});
    if(r.ok)appendLog('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø°Ø§ÙƒØ±Ø©.');
  }catch(e){appendLog(`âš ï¸ Ø®Ø·Ø£ Ø­ÙØ¸ Ø§Ù„Ø°Ø§ÙƒØ±Ø©: ${e.message}`);}
}
async function fetchModels(){
  const s=document.getElementById('model-select');
  s.innerHTML='<option value="">-- ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬... --</option>';
  EXTERNAL_MODELS.forEach(m=>{const o=document.createElement('option');o.value=m.value;o.textContent=m.name;s.appendChild(o);});
  try{
    const r=await fetch(CONFIG.OLLAMA_BASE+'/api/tags');if(!r.ok)throw new Error('Ollama ØºÙŠØ± Ù…ØªØ§Ø­');
    const d=await r.json();const names=d.models.map(x=>x.name);
    const g=document.createElement('optgroup');g.label='Ù†Ù…Ø§Ø°Ø¬ Ollama Ø§Ù„Ù…Ø­Ù„ÙŠØ©';
    names.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;g.appendChild(o);});
    s.appendChild(g);appendLog(`âœ… ØªØ­Ù…ÙŠÙ„ ${names.length} Ù†Ù…ÙˆØ°Ø¬ Ù…Ø­Ù„ÙŠ.`);
    s.options[0].textContent='-- Ø§Ø®ØªØ± ÙˆÙƒÙŠÙ„/Ù†Ù…ÙˆØ°Ø¬ --';setConnectionStatus(true);
  }catch(e){appendLog(`âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Ollama: ${e.message}`);setConnectionStatus(false);}
}

// ====== Highlight Flow Steps ======
function highlightFlowStep(stepIndex){
  const steps=document.querySelectorAll('.flow-step');
  steps.forEach((s,i)=>{
    if(i<stepIndex){s.style.background='linear-gradient(135deg,var(--accent),#3a3a3a33)';s.style.color='#fff';}
    else if(i===stepIndex){s.style.background='var(--glass-strong)';s.style.boxShadow='0 0 20px rgba(126,231,135,0.4)';s.style.color='var(--accent)';}
    else{s.style.background='var(--glass)';s.style.boxShadow='none';s.style.color='var(--muted)';}
  });
}

window.onload=function(){
  document.getElementById('client-display').textContent=`Client: ${CONFIG.DEFAULT_CLIENT_ID}`;
  const p=new URLSearchParams(window.location.search);
  const ip=p.get('ip')||'127.0.0.1';
  document.getElementById('api-ip').value=ip;
  updateGatewayURL(ip);
  document.getElementById('user-input').addEventListener('keypress',function(e){
    if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage(this.value);}
  });
};
</script>
</body>
</html>